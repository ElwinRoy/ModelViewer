<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sneakers AR Experience</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: white;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #cameraBackground {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover;
      z-index: 1;
    }
    #introScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }
    .intro-ripple {
      position: absolute;
      width: 300px; height: 300px;
      border-radius: 50%;
      border: 1px solid rgba(0, 212, 255, 0.3);
      animation: rippleExpand 3s ease-out infinite;
    }
    .intro-ripple:nth-child(2) { animation-delay: 1s; }
    .intro-ripple:nth-child(3) { animation-delay: 2s; }
    @keyframes rippleExpand {
      0% { transform: scale(0.5); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }
    .press-button {
      position: relative;
      width: 180px; height: 180px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(0, 255, 157, 0.3), rgba(0, 212, 255, 0.15), rgba(0, 100, 150, 0.2));
      border: 2px solid rgba(0, 212, 255, 0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      color: white;
      text-align: center;
      animation: pulseButton 2.5s infinite;
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    @keyframes pulseButton {
      0%, 100% { transform: scale(1); box-shadow: 0 0 40px rgba(0, 212, 255, 0.5); }
      50% { transform: scale(1.02); box-shadow: 0 0 60px rgba(0, 212, 255, 0.7); }
    }
    .press-button:active { transform: scale(0.95); }

    /* VIDEO SCREEN */
    #videoScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 90;
      display: none;
      align-items: center;
      justify-content: center;
      perspective: 1200px;
      overflow: hidden;
      background: transparent;
    }
    
    /* Glow effect contained only around the video container */
    .video-glow-wrapper {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 320px; height: 500px;
      pointer-events: none;
      z-index: 0;
    }
    
    .background-glow {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 280px; height: 420px;
      border-radius: 40px;
      background: radial-gradient(ellipse at center, 
        rgba(0, 212, 255, 0.5) 0%, 
        rgba(0, 180, 255, 0.35) 30%,
        rgba(0, 150, 255, 0.2) 50%,
        transparent 70%);
      filter: blur(40px);
      animation: bgGlowPulse 3s ease-in-out infinite;
    }
    .background-glow-secondary {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 320px; height: 480px;
      border-radius: 50px;
      background: radial-gradient(ellipse at center, 
        rgba(0, 255, 136, 0.35) 0%, 
        rgba(0, 220, 120, 0.2) 35%,
        transparent 65%);
      filter: blur(50px);
      animation: bgGlowPulse2 4s ease-in-out infinite;
    }
    .background-glow-accent {
      position: absolute;
      top: 40%; left: 50%;
      transform: translate(-50%, -50%);
      width: 250px; height: 350px;
      border-radius: 40px;
      background: radial-gradient(ellipse at center, 
        rgba(255, 107, 53, 0.4) 0%, 
        rgba(247, 147, 30, 0.25) 35%,
        transparent 65%);
      filter: blur(35px);
      animation: bgGlowPulse3 5s ease-in-out infinite;
    }
    @keyframes bgGlowPulse {
      0%, 100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
    }
    @keyframes bgGlowPulse2 {
      0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 0.95; transform: translate(-50%, -50%) scale(1.08); }
    }
    @keyframes bgGlowPulse3 {
      0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 0.9; transform: translate(-50%, -50%) scale(1.15); }
    }
    
    .particles-container {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 2;
    }
    
    .particle {
      position: absolute;
      border-radius: 50%;
      animation: floatParticle linear infinite;
    }
    .particle.glow {
      background: radial-gradient(circle, rgba(0, 212, 255, 1) 0%, rgba(0, 212, 255, 0.6) 40%, transparent 70%);
      box-shadow: 0 0 6px rgba(0, 212, 255, 0.7);
    }
    .particle.spark {
      background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(0, 255, 136, 0.7) 50%, transparent 70%);
      box-shadow: 0 0 5px rgba(255, 255, 255, 0.6);
    }
    .particle.orb {
      background: radial-gradient(circle, rgba(255, 200, 100, 1) 0%, rgba(255, 107, 53, 0.6) 50%, transparent 70%);
      box-shadow: 0 0 6px rgba(255, 200, 100, 0.6);
    }
    @keyframes floatParticle {
      0% { transform: translateY(100vh) rotate(0deg) scale(0.5); opacity: 0; }
      10% { opacity: 1; }
      50% { opacity: 1; transform: translateY(50vh) rotate(360deg) scale(1); }
      90% { opacity: 0.8; }
      100% { transform: translateY(-50px) rotate(720deg) scale(0.5); opacity: 0; }
    }
    .particle.sway {
      animation: floatParticleSway linear infinite;
    }
    @keyframes floatParticleSway {
      0% { transform: translateY(100vh) translateX(0) scale(0.5); opacity: 0; }
      10% { opacity: 1; }
      25% { transform: translateY(75vh) translateX(20px) scale(0.8); }
      50% { transform: translateY(50vh) translateX(-15px) scale(1); opacity: 1; }
      75% { transform: translateY(25vh) translateX(15px) scale(0.9); }
      90% { opacity: 0.7; }
      100% { transform: translateY(-50px) translateX(0) scale(0.5); opacity: 0; }
    }
    
    .sound-waves {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 35px;
      z-index: 96;
    }
    .wave-bar {
      width: 3px;
      background: linear-gradient(to top, #00d4ff, #00ff88, #fff);
      border-radius: 3px;
      animation: waveAnimation 0.5s ease-in-out infinite alternate;
      box-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
    }
    @keyframes waveAnimation {
      0% { height: 5px; }
      100% { height: 28px; }
    }
    .spatial-container {
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.1s ease-out;
      will-change: transform;
      z-index: 10;
    }
    .spatial-frame {
      position: relative;
      width: 220px; height: 390px;
      transform-style: preserve-3d;
    }
    .depth-layer-back { position: absolute; top: 8px; left: 8px; width: 204px; height: 374px; background: rgba(0,0,0,0.3); border-radius: 12px; transform: translateZ(-60px); }
    .depth-layer-mid { position: absolute; top: 4px; left: 4px; width: 212px; height: 382px; background: rgba(0,0,0,0.2); border-radius: 14px; transform: translateZ(-30px); }
    .video-spatial-container {
      position: relative;
      width: 220px; height: 390px;
      transform-style: preserve-3d;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(0, 212, 255, 0.2);
    }
    #videoPlayer {
      width: 100%; height: 100%;
      object-fit: cover;
      border-radius: 15px;
    }
    .visualize-button {
      position: absolute;
      bottom: 15px; left: 50%;
      transform: translateX(-50%);
      padding: 8px 18px;
      font-size: 10px;
      font-weight: 500;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transition: all 0.5s ease;
    }
    .visualize-button.visible { opacity: 1; visibility: visible; }
    .visualize-button:active { transform: translateX(-50%) scale(0.95); }
    .floor-shadow {
      position: absolute;
      bottom: -60px; left: 50%;
      transform: translateX(-50%);
      width: 180px; height: 80px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.4) 0%, transparent 70%);
      filter: blur(15px);
    }
    .gyro-hint {
      position: fixed;
      bottom: 130px; left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: rgba(255,255,255,0.7);
      text-align: center;
      background: rgba(0,0,0,0.4);
      padding: 6px 14px;
      border-radius: 20px;
      backdrop-filter: blur(5px);
      transition: opacity 0.5s ease;
      z-index: 95;
    }

    /* MODELS SCREEN */
    #modelsScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 80;
      display: none;
      flex-direction: column;
      overflow: hidden;
      background: transparent;
    }
    
    /* Added gentle fade-in and slide-up animations for models screen */
    @keyframes fadeSlideIn {
      0% { opacity: 0; transform: translateY(30px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes cardFadeIn {
      0% { opacity: 0; transform: translateY(20px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .models-scroll-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 12px;
      padding-bottom: 100px;
    }
    .models-header {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px 15px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      animation: fadeSlideIn 0.5s ease-out forwards;
    }
    .models-header h2 { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
    .models-header p { font-size: 12px; opacity: 0.7; }
    .shoes-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      max-width: 400px;
      margin: 0 auto;
      padding-bottom: 20px;
    }
    .shoe-card {
      background: transparent;
      border-radius: 20px;
      overflow: visible;
      opacity: 0;
      animation: cardFadeIn 0.6s ease-out forwards;
    }
    .shoe-card:nth-child(1) { animation-delay: 0.1s; }
    .shoe-card:nth-child(2) { animation-delay: 0.2s; }
    .shoe-card:nth-child(3) { animation-delay: 0.3s; }
    
    .model-wrap {
      height: 220px;
      background: transparent !important;
      touch-action: pan-y;
      position: relative;
    }
    .model-wrap model-viewer {
      width: 100%; height: 100%;
      background-color: transparent !important;
      --poster-color: transparent;
      --progress-bar-color: transparent;
      touch-action: pan-y;
    }
    .info {
      padding: 18px 15px;
      text-align: center;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      margin-top: 10px;
    }
    .info h3 { font-size: 18px; margin-bottom: 5px; font-weight: 600; }
    .info .price { opacity: 0.7; font-size: 15px; margin-bottom: 15px; }
    .btn-3d-home {
      background: #fff;
      color: #000;
      border: none;
      padding: 14px 20px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 0 auto;
      width: 100%;
    }
    .btn-3d-home:active { transform: scale(0.97); background: #eee; }
    .back-to-video-btn {
      position: fixed;
      bottom: 25px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      z-index: 86;
      backdrop-filter: blur(10px);
    }
    .back-to-video-btn:active { transform: translateX(-50%) scale(0.95); }

    /* AR DETAIL VIEW */
    #arDetailView {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: none;
      z-index: 110;
      background: transparent;
      overflow: visible;
    }
    
    /* Model container now uses much larger dimensions to prevent clipping */
    #arModelContainer {
      position: fixed;
      width: 300vw;
      height: 300vh;
      top: -100vh;
      left: -100vw;
      z-index: 111;
      pointer-events: none;
      overflow: visible;
    }
    
    #ar3DModel {
      position: absolute;
      width: 100vw;
      height: 100vh;
      top: 100vh;
      left: 100vw;
      --poster-color: transparent;
      background-color: transparent !important;
      touch-action: none;
      pointer-events: auto;
    }
    
    /* Touch overlay to intercept 1-finger drag */
    #arTouchOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 112;
      background: transparent;
      touch-action: none;
    }
    
    .top-bar {
      position: fixed;
      top: 20px; left: 15px; right: 15px;
      display: flex;
      justify-content: center;
      z-index: 115;
    }
    .model-name-badge {
      background: rgba(0,0,0,0.6);
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }

    .gesture-hint {
      position: fixed;
      top: 70px; left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: rgba(255,255,255,0.8);
      text-align: center;
      background: rgba(0,0,0,0.5);
      padding: 8px 16px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      z-index: 115;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    .gesture-hint.hidden { opacity: 0; pointer-events: none; }

    .bottom-bar {
      position: fixed;
      bottom: 25px; left: 15px; right: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      z-index: 115;
    }
    
    .capture-btn {
      background: rgba(0,0,0,0.6);
      border: 2px solid rgba(255,255,255,0.4);
      color: white;
      padding: 14px 35px;
      border-radius: 30px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .capture-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }

    .order-btn {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      border: none;
      padding: 14px 40px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      max-width: 280px;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 20px rgba(255,107,53,0.4);
    }
    .order-btn:active { transform: scale(0.97); }
    .action-row {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 280px;
      justify-content: center;
    }
    .action-btn {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 11px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      flex: 1;
      text-align: center;
    }
    .action-btn:active { background: rgba(255,255,255,0.1); }

    #captureCanvas {
      display: none;
    }

    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      flex-direction: column;
      gap: 15px;
    }
    .loading-overlay.active { display: flex; }
    .loader {
      width: 40px; height: 40px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <video id="cameraBackground" autoplay playsinline muted></video>
  <canvas id="captureCanvas"></canvas>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
    <div>Loading...</div>
  </div>

  <div id="introScreen">
    <div class="intro-ripple"></div>
    <div class="intro-ripple"></div>
    <div class="intro-ripple"></div>
    <button class="press-button" id="startBtn">TAP TO<br>START</button>
  </div>

  <!-- VIDEO SCREEN -->
  <div id="videoScreen">
    <!-- Glow wrapper positioned around video only -->
    <div class="video-glow-wrapper">
      <div class="background-glow"></div>
      <div class="background-glow-secondary"></div>
      <div class="background-glow-accent"></div>
    </div>
    <div class="particles-container" id="particlesContainer"></div>
    <div class="sound-waves" id="soundWaves">
      <div class="wave-bar" style="animation-delay: 0s;"></div>
      <div class="wave-bar" style="animation-delay: 0.1s;"></div>
      <div class="wave-bar" style="animation-delay: 0.2s;"></div>
      <div class="wave-bar" style="animation-delay: 0.3s;"></div>
      <div class="wave-bar" style="animation-delay: 0.4s;"></div>
      <div class="wave-bar" style="animation-delay: 0.35s;"></div>
      <div class="wave-bar" style="animation-delay: 0.25s;"></div>
      <div class="wave-bar" style="animation-delay: 0.15s;"></div>
      <div class="wave-bar" style="animation-delay: 0.05s;"></div>
    </div>
    <div class="gyro-hint" id="gyroHint">Tilt or drag to explore depth</div>
    <div class="spatial-container" id="spatialContainer">
      <div class="spatial-frame">
        <div class="depth-layer-back"></div>
        <div class="depth-layer-mid"></div>
        <div class="video-spatial-container">
          <video id="videoPlayer" playsinline loop>
            <source src="https://github.com/ElwinRoy/ModelViewer/raw/main/nike.mp4" type="video/mp4">
          </video>
          <button class="visualize-button" id="visualizeBtn">View Models</button>
        </div>
        <div class="floor-shadow"></div>
      </div>
    </div>
  </div>

  <!-- MODELS SCREEN -->
  <div id="modelsScreen">
    <div class="models-scroll-container" id="scrollContainer">
      <div class="models-header">
        <h2>Choose Your Sneaker</h2>
        <p>Select a model to view in AR</p>
      </div>
      <div class="shoes-grid" id="shoesGrid"></div>
    </div>
    <button class="back-to-video-btn" id="backToVideoBtn">Back to Video</button>
  </div>

  <!-- AR VIEW -->
  <div id="arDetailView">
    <!-- Container is 300vw x 300vh so model never clips -->
    <div id="arModelContainer">
      <!-- camera-controls enabled, removed disable-zoom for proper rotation -->
      <model-viewer id="ar3DModel"
        ar ar-modes="webxr scene-viewer quick-look"
        camera-controls
        disable-tap
        shadow-intensity="1" exposure="1.0"
        interaction-prompt="none" environment-image="neutral">
      </model-viewer>
    </div>
    
    <div id="arTouchOverlay"></div>

    <div class="top-bar">
      <div class="model-name-badge" id="modelName">Sneaker</div>
    </div>
    
    <div class="gesture-hint" id="gestureHint">
      1 finger: Move | 2 fingers: Rotate & Scale
    </div>

    <div class="bottom-bar">
      <button class="capture-btn" id="captureBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <circle cx="12" cy="12" r="4"/>
        </svg>
        Capture
      </button>
      <button class="order-btn" id="orderBtn">Order Now</button>
      <div class="action-row">
        <button class="action-btn" id="replayBtn">Replay</button>
        <button class="action-btn" id="backBtn">Back</button>
      </div>
    </div>
  </div>

  <script>
    const shoes = [
      { name: "New Balance 997", price: "₹14,999", model: "https://cdn.jsdelivr.net/gh/ElwinRoy/test@main/Shoe%2001%20(1).glb" },
      { name: "Formal Edge", price: "₹12,999", model: "https://cdn.jsdelivr.net/gh/ElwinRoy/test@main/Shoe%2002%20(1).glb" },
      { name: "ND Runner", price: "₹16,999", model: "https://cdn.jsdelivr.net/gh/ElwinRoy/test@main/Shoe%2003%20(1).glb" }
    ];
    const ORDER_URL = "https://www.superkicks.in/?srsltid=AfmBOor9rXpYcBLeJhsC4CYMZvB6CJ-OI5h10Zxmq_ZbkrqnLp4p2dUE";

    const $ = id => document.getElementById(id);
    const el = {
      camera: $("cameraBackground"),
      intro: $("introScreen"),
      video: $("videoScreen"),
      models: $("modelsScreen"),
      ar: $("arDetailView"),
      model3d: $("ar3DModel"),
      modelContainer: $("arModelContainer"),
      touchOverlay: $("arTouchOverlay"),
      startBtn: $("startBtn"),
      visualizeBtn: $("visualizeBtn"),
      videoPlayer: $("videoPlayer"),
      shoesGrid: $("shoesGrid"),
      modelName: $("modelName"),
      loading: $("loadingOverlay"),
      captureBtn: $("captureBtn"),
      orderBtn: $("orderBtn"),
      replayBtn: $("replayBtn"),
      backBtn: $("backBtn"),
      backToVideoBtn: $("backToVideoBtn"),
      scrollContainer: $("scrollContainer"),
      soundWaves: $("soundWaves"),
      particlesContainer: $("particlesContainer"),
      spatialContainer: $("spatialContainer"),
      gyroHint: $("gyroHint"),
      captureCanvas: $("captureCanvas"),
      gestureHint: $("gestureHint")
    };

    let cameraStream = null;
    let currentShoe = null;
    let buttonTimeout = null;
    let vibrationInterval = null;

    // Parallax for video screen
    let rotateX = 0, rotateY = 0, targetRotateX = 0, targetRotateY = 0;
    let isGyroActive = false, isDragging = false;
    let lastTouchX = 0, lastTouchY = 0;

    // AR model transform state
    let modelScale = 1;
    let modelPosX = 0;
    let modelPosY = 0;
    let initialPinchDistance = 0;
    let initialScale = 1;
    let isTwoFingerGesture = false;
    let isOneFingerDrag = false;
    let lastDragX = 0;
    let lastDragY = 0;

    function initGyroscope() {
      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        document.addEventListener('click', () => DeviceOrientationEvent.requestPermission().then(r => { if (r === 'granted') window.addEventListener('deviceorientation', handleOrientation); }), { once: true });
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', handleOrientation);
        isGyroActive = true;
      }
    }
    function handleOrientation(e) {
      if (!el.video.style.display || el.video.style.display === 'none') return;
      const beta = e.beta || 0; const gamma = e.gamma || 0;
      targetRotateX = Math.max(-12, Math.min(12, (beta - 45) * 0.25));
      targetRotateY = Math.max(-12, Math.min(12, gamma * 0.35));
    }
    function initDragParallax() {
      const c = el.spatialContainer;
      c.addEventListener('touchstart', e => { isDragging = true; lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; el.gyroHint.style.opacity = '0'; });
      c.addEventListener('touchmove', e => { if (!isDragging) return; const dx = e.touches[0].clientX - lastTouchX; const dy = e.touches[0].clientY - lastTouchY; targetRotateY += dx * 0.12; targetRotateX -= dy * 0.12; targetRotateX = Math.max(-15, Math.min(15, targetRotateX)); targetRotateY = Math.max(-20, Math.min(20, targetRotateY)); lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; });
      c.addEventListener('touchend', () => { isDragging = false; });
      c.addEventListener('mousedown', e => { isDragging = true; lastTouchX = e.clientX; lastTouchY = e.clientY; });
      window.addEventListener('mousemove', e => { if (!isDragging) return; const dx = e.clientX - lastTouchX; const dy = e.clientY - lastTouchY; targetRotateY += dx * 0.08; targetRotateX -= dy * 0.08; targetRotateX = Math.max(-15, Math.min(15, targetRotateX)); targetRotateY = Math.max(-20, Math.min(20, targetRotateY)); lastTouchX = e.clientX; lastTouchY = e.clientY; });
      window.addEventListener('mouseup', () => isDragging = false);
    }
    function animateParallax() {
      rotateX += (targetRotateX - rotateX) * 0.1;
      rotateY += (targetRotateY - rotateY) * 0.1;
      if (el.spatialContainer) el.spatialContainer.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      requestAnimationFrame(animateParallax);
    }
    initGyroscope();
    initDragParallax();
    animateParallax();

    function createParticles() {
      const c = el.particlesContainer; c.innerHTML = '';
      const particleTypes = ['glow', 'spark', 'orb'];
      const animationTypes = ['', 'sway'];
      const particleCount = 10;
      
      for (let i = 0; i < particleCount; i++) {
        const p = document.createElement('div');
        const type = particleTypes[Math.floor(Math.random() * particleTypes.length)];
        const anim = animationTypes[Math.floor(Math.random() * animationTypes.length)];
        p.className = `particle ${type}${anim ? ' ' + anim : ''}`;
        
        const s = Math.random() * 3 + 2;
        p.style.width = s + 'px';
        p.style.height = s + 'px';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDuration = (Math.random() * 5 + 6) + 's';
        p.style.animationDelay = (Math.random() * 6) + 's';
        c.appendChild(p);
      }
    }

    const Haptic = {
      supported: 'vibrate' in navigator,
      tap(ms = 50) { if (this.supported) navigator.vibrate(ms); },
      startup() { if (this.supported) navigator.vibrate([100,50,100,50,200]); },
      success() { if (this.supported) navigator.vibrate([30,30,30,30,60]); },
      videoStart() { 
        if (this.supported) { 
          const p = () => navigator.vibrate([40,80,40,80,40,80]); 
          p(); 
          vibrationInterval = setInterval(p, 800); 
        } 
      },
      stop() { 
        if (this.supported) navigator.vibrate(0); 
        if (vibrationInterval) {
          clearInterval(vibrationInterval);
          vibrationInterval = null;
        }
      }
    };

    async function initCamera() {
      const opts = [{ video: { facingMode: { exact: "environment" } } }, { video: { facingMode: "environment" } }, { video: true }];
      for (const opt of opts) {
        try { cameraStream = await navigator.mediaDevices.getUserMedia(opt); el.camera.srcObject = cameraStream; await el.camera.play(); return; } catch (e) {}
      }
      document.body.style.background = "#1a1a2e";
    }
    initCamera();

    function showViewModelsButton() { el.visualizeBtn.classList.add('visible'); Haptic.success(); }

    el.startBtn.onclick = async () => {
      Haptic.startup();
      el.intro.style.display = "none";
      el.video.style.display = "flex";
      el.visualizeBtn.classList.remove('visible');
      targetRotateX = targetRotateY = 0;
      el.gyroHint.style.opacity = '1';
      createParticles();
      el.videoPlayer.muted = false;
      try { await el.videoPlayer.play(); Haptic.videoStart(); setTimeout(() => el.gyroHint.style.opacity = '0', 4000); buttonTimeout = setTimeout(showViewModelsButton, 10000); }
      catch { el.videoPlayer.muted = true; el.videoPlayer.play(); setTimeout(() => el.videoPlayer.muted = false, 100); buttonTimeout = setTimeout(showViewModelsButton, 10000); }
    };

    el.visualizeBtn.onclick = () => {
      Haptic.stop();
      Haptic.tap(30);
      clearTimeout(buttonTimeout);
      el.videoPlayer.pause();
      el.visualizeBtn.classList.remove('visible');
      el.video.style.display = "none";
      el.models.style.display = "flex";
    };

    el.backToVideoBtn.onclick = () => {
      Haptic.tap(30);
      el.models.style.display = "none";
      el.video.style.display = "flex";
      el.videoPlayer.currentTime = 0;
      el.videoPlayer.play();
      Haptic.videoStart();
      createParticles();
      targetRotateX = targetRotateY = 0;
      el.gyroHint.style.opacity = '1';
      setTimeout(() => el.gyroHint.style.opacity = '0', 4000);
      buttonTimeout = setTimeout(showViewModelsButton, 10000);
    };

    // Generate shoe cards
    shoes.forEach((shoe, i) => {
      const card = document.createElement("div"); card.className = "shoe-card";
      card.innerHTML = `
        <div class="model-wrap">
          <model-viewer src="${shoe.model}" auto-rotate rotation-per-second="25deg" interaction-prompt="none" shadow-intensity="0" exposure="1.0" camera-orbit="0deg 75deg auto" field-of-view="auto" loading="eager" touch-action="pan-y" style="background-color: transparent;"></model-viewer>
        </div>
        <div class="info">
          <h3>${shoe.name}</h3>
          <div class="price">${shoe.price}</div>
          <button class="btn-3d-home" data-i="${i}">View in AR</button>
        </div>`;
      el.shoesGrid.appendChild(card);
    });

    function getTouchDistance(touches) {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function applyModelTransform() {
      modelScale = Math.max(0.3, Math.min(3, modelScale));
      el.modelContainer.style.transform = `translate(${modelPosX}px, ${modelPosY}px) scale(${modelScale})`;
    }

    function resetModelTransform() {
      modelScale = 1;
      modelPosX = 0;
      modelPosY = 0;
      el.modelContainer.style.transform = 'translate(0px, 0px) scale(1)';
      el.gestureHint.classList.remove('hidden');
      setTimeout(() => el.gestureHint.classList.add('hidden'), 4000);
    }

    function initARTouchControls() {
      const overlay = el.touchOverlay;
      const modelViewer = el.model3d;
      
      overlay.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          // Two fingers - let model-viewer handle rotation, we handle scale
          isTwoFingerGesture = true;
          isOneFingerDrag = false;
          initialPinchDistance = getTouchDistance(e.touches);
          initialScale = modelScale;
          
          // Hide overlay so model-viewer can handle rotation
          overlay.style.pointerEvents = 'none';
        } else if (e.touches.length === 1) {
          // One finger - we handle drag, prevent rotation
          e.preventDefault();
          e.stopPropagation();
          isOneFingerDrag = true;
          isTwoFingerGesture = false;
          lastDragX = e.touches[0].clientX;
          lastDragY = e.touches[0].clientY;
          el.gestureHint.classList.add('hidden');
        }
      }, { passive: false });

      overlay.addEventListener('touchmove', (e) => {
        if (isOneFingerDrag && e.touches.length === 1) {
          e.preventDefault();
          e.stopPropagation();
          // Drag to move - no boundaries
          const dx = e.touches[0].clientX - lastDragX;
          const dy = e.touches[0].clientY - lastDragY;
          modelPosX += dx;
          modelPosY += dy;
          lastDragX = e.touches[0].clientX;
          lastDragY = e.touches[0].clientY;
          applyModelTransform();
        }
      }, { passive: false });

      overlay.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) {
          isTwoFingerGesture = false;
          // Re-enable overlay after two-finger gesture ends
          overlay.style.pointerEvents = 'auto';
        }
        if (e.touches.length === 0) {
          isOneFingerDrag = false;
        }
        // If switching from 2 to 1 finger, start tracking as drag
        if (e.touches.length === 1 && !isOneFingerDrag) {
          isOneFingerDrag = true;
          lastDragX = e.touches[0].clientX;
          lastDragY = e.touches[0].clientY;
        }
      });

      // Handle pinch scale when model-viewer gets touch events
      modelViewer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          initialPinchDistance = getTouchDistance(e.touches);
          initialScale = modelScale;
        }
      }, { passive: true });

      modelViewer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          const currentDistance = getTouchDistance(e.touches);
          const scaleChange = currentDistance / initialPinchDistance;
          modelScale = initialScale * scaleChange;
          applyModelTransform();
        }
      }, { passive: true });

      // Mouse support for desktop testing
      let isMouseDragging = false;
      overlay.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isMouseDragging = true;
        lastDragX = e.clientX;
        lastDragY = e.clientY;
      });

      window.addEventListener('mousemove', (e) => {
        if (!isMouseDragging) return;
        const dx = e.clientX - lastDragX;
        const dy = e.clientY - lastDragY;
        modelPosX += dx;
        modelPosY += dy;
        lastDragX = e.clientX;
        lastDragY = e.clientY;
        applyModelTransform();
      });

      window.addEventListener('mouseup', () => { isMouseDragging = false; });

      overlay.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        modelScale *= delta;
        applyModelTransform();
      }, { passive: false });
    }

    initARTouchControls();

    document.querySelectorAll('.btn-3d-home').forEach(btn => {
      btn.onclick = e => {
        e.stopPropagation();
        Haptic.stop(); // Stop vibration when entering AR
        Haptic.tap(30);
        const i = parseInt(btn.dataset.i);
        currentShoe = shoes[i];
        el.modelName.textContent = currentShoe.name;
        el.loading.classList.add('active');
        el.models.style.display = "none";
        el.ar.style.display = "block";
        el.model3d.src = currentShoe.model;
        el.model3d.cameraOrbit = "0deg 75deg 105%";
        el.model3d.removeAttribute("auto-rotate");
        
        // Re-enable touch overlay
        el.touchOverlay.style.pointerEvents = 'auto';
        
        resetModelTransform();
        el.model3d.addEventListener('load', () => { 
          el.loading.classList.remove('active'); 
        }, { once: true });
      };
    });

    el.captureBtn.onclick = async () => {
      Haptic.tap(50);
      const modelViewer = el.model3d;
      const canvas = el.captureCanvas;
      const ctx = canvas.getContext('2d');
      
      try {
        const width = window.innerWidth;
        const height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        
        // Draw camera background first
        if (el.camera.srcObject && el.camera.videoWidth > 0) {
          const videoRatio = el.camera.videoWidth / el.camera.videoHeight;
          const canvasRatio = width / height;
          let drawWidth, drawHeight, drawX, drawY;
          
          if (videoRatio > canvasRatio) {
            drawHeight = height;
            drawWidth = height * videoRatio;
            drawX = (width - drawWidth) / 2;
            drawY = 0;
          } else {
            drawWidth = width;
            drawHeight = width / videoRatio;
            drawX = 0;
            drawY = (height - drawHeight) / 2;
          }
          
          ctx.drawImage(el.camera, drawX, drawY, drawWidth, drawHeight);
        } else {
          ctx.fillStyle = '#1a1a2e';
          ctx.fillRect(0, 0, width, height);
        }
        
        // Get model snapshot and overlay
        const modelBlob = await modelViewer.toBlob({ idealAspect: false });
        const modelImg = new Image();
        modelImg.crossOrigin = 'anonymous';
        
        await new Promise((resolve, reject) => {
          modelImg.onload = resolve;
          modelImg.onerror = reject;
          modelImg.src = URL.createObjectURL(modelBlob);
        });
        
        // Apply same transforms as on screen
        ctx.save();
        ctx.translate(width / 2 + modelPosX, height / 2 + modelPosY);
        ctx.scale(modelScale, modelScale);
        ctx.drawImage(modelImg, -width / 2, -height / 2, width, height);
        ctx.restore();
        
        URL.revokeObjectURL(modelImg.src);
        
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${currentShoe.name.replace(/ /g, '_')}_AR.png`;
          a.click();
          URL.revokeObjectURL(url);
          Haptic.tap(30);
        }, 'image/png');
        
      } catch (err) {
        console.error('Capture error:', err);
        alert("Capture failed. Try again.");
      }
    };

    el.orderBtn.onclick = () => { Haptic.tap(30); window.open(ORDER_URL, '_blank'); };
    
    el.replayBtn.onclick = () => {
      Haptic.tap(30);
      el.ar.style.display = "none";
      el.video.style.display = "flex";
      el.videoPlayer.currentTime = 0;
      el.videoPlayer.play();
      Haptic.videoStart();
      createParticles();
      targetRotateX = targetRotateY = 0;
      el.gyroHint.style.opacity = '1';
      setTimeout(() => el.gyroHint.style.opacity = '0', 4000);
      buttonTimeout = setTimeout(showViewModelsButton, 10000);
    };
    
    el.backBtn.onclick = () => { 
      Haptic.tap(30); 
      el.ar.style.display = "none"; 
      el.models.style.display = "flex"; 
    };

    window.addEventListener('beforeunload', () => { Haptic.stop(); if (cameraStream) cameraStream.getTracks().forEach(t => t.stop()); });
    document.addEventListener('visibilitychange', async () => { if (document.hidden && cameraStream) cameraStream.getTracks().forEach(t => t.stop()); else await initCamera(); });
  </script>
</body>
</html>
