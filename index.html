<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sneakers AR Experience</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      position: fixed;
      touch-action: none;
    }

    #cameraBackground {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 1;
    }

    #introScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .press-button {
      position: relative;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(0, 255, 157, 0.3), rgba(0, 212, 255, 0.15), rgba(0, 100, 150, 0.2));
      border: 2px solid rgba(0, 212, 255, 0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      color: white;
      text-align: center;
      animation: pulseButton 2.5s infinite;
      backdrop-filter: blur(10px);
    }

    @keyframes pulseButton {
      0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 40px rgba(0, 212, 255, 0.5), 0 0 80px rgba(0, 255, 157, 0.2);
      }
      50% { 
        transform: scale(1.02); 
        box-shadow: 0 0 60px rgba(0, 212, 255, 0.7), 0 0 100px rgba(0, 255, 157, 0.4);
      }
    }

    .press-button:active { transform: scale(0.95); }

    #videoScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 90;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .volume-warning {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 18px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 500;
      z-index: 95;
    }

    .volume-icon {
      width: 18px;
      height: 18px;
      filter: brightness(0) invert(1);
    }

    /* Video container - BIGGER */
    .video-container {
      position: relative;
      width: 80%;
      max-width: 300px;
      aspect-ratio: 9/16;
      border-radius: 0;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: #000;
    }

    #videoPlayer {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #videoPlayer::-webkit-media-controls { display: none !important; }

    .visualize-button {
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 30px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 25px;
      border: none;
      background: rgba(255, 255, 255, 0.95);
      color: #000;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      z-index: 10;
    }

    .visualize-button:active { transform: translateX(-50%) scale(0.95); }

    #modelsScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 80;
      display: none;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px 12px;
      -webkit-overflow-scrolling: touch;
    }

    .models-header {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px 15px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border-radius: 15px;
    }

    .models-header h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 5px;
      color: #fff;
    }

    .models-header p {
      font-size: 12px;
      opacity: 0.7;
    }

    .shoes-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      max-width: 400px;
      margin: 0 auto;
      padding-bottom: 20px;
    }

    .shoe-card {
      background: transparent;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .model-wrap { 
      height: 200px; 
      background: transparent;
    }
    
    .model-wrap model-viewer { 
      width: 100%; 
      height: 100%; 
      background: transparent;
      --poster-color: transparent;
    }

    .info { 
      padding: 18px 15px; 
      text-align: center;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
    }
    
    .info h3 { 
      font-size: 18px; 
      margin-bottom: 5px; 
      font-weight: 600;
      color: #fff;
    }
    
    .info .price { 
      opacity: 0.7; 
      font-size: 15px; 
      margin-bottom: 15px;
    }

    .btn-3d-home {
      background: #fff;
      color: #000;
      border: none;
      padding: 14px 20px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 0 auto;
      width: 100%;
    }
    
    .btn-3d-home:active { 
      transform: scale(0.97);
      background: #eee;
    }

    #arDetailView { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100vw; 
      height: 100vh; 
      display: none; 
      z-index: 110; 
    }

    #ar3DModel {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100vw; 
      height: 100vh; 
      z-index: 111;
      --poster-color: transparent;
      background: transparent;
    }

    .color-indicator {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 14px;
      border-radius: 20px;
      z-index: 116;
      font-size: 11px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .size-info {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 14px;
      border-radius: 15px;
      z-index: 113;
      font-size: 11px;
    }

    .size-info strong {
      color: #00d4ff;
      display: block;
      font-size: 9px;
      letter-spacing: 1px;
      margin-bottom: 2px;
    }

    #modelName { font-weight: 500; font-size: 12px; }

    .ar-controls {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 115;
    }

    .ar-control-btn {
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 16px;
      border-radius: 25px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .ar-control-btn:active { background: rgba(255, 255, 255, 0.2); }

    .ar-control-btn.active {
      background: rgba(255, 255, 255, 0.9);
      color: #000;
    }

    .scale-controls {
      position: fixed;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 115;
    }

    .scale-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 20px;
      font-weight: 400;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scale-btn:active { background: rgba(255, 255, 255, 0.2); }

    .scale-label {
      text-align: center;
      font-size: 9px;
      opacity: 0.6;
      margin-top: 3px;
    }

    .color-panel {
      position: fixed;
      bottom: 160px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      padding: 15px;
      border-radius: 20px;
      z-index: 114;
      display: none;
      flex-direction: column;
      gap: 12px;
      width: 85%;
      max-width: 300px;
    }

    .color-panel.active { display: flex; }

    .color-label {
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.7;
    }

    .color-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .color-btn {
      padding: 10px 8px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .color-btn .color-preview {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .color-btn:active { background: rgba(255, 255, 255, 0.1); }

    .color-btn.selected {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.4);
    }

    #closeARDetail {
      position: fixed;
      bottom: 35px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 30px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      z-index: 115;
      cursor: pointer;
    }

    #closeARDetail:active { background: rgba(255, 255, 255, 0.1); }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      flex-direction: column;
      gap: 15px;
    }

    .loading-overlay.active { display: flex; }

    .loader {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text { font-size: 12px; opacity: 0.7; }
  </style>
</head>
<body>

  <video id="cameraBackground" autoplay playsinline muted></video>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <div id="introScreen">
    <button class="press-button" id="startBtn">CLICK TO<br>START</button>
  </div>

  <div id="videoScreen">
    <div class="volume-warning">
      <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" class="volume-icon">
      <span>VOLUME UP</span>
    </div>
    
    <div class="video-container">
      <video id="videoPlayer" playsinline loop muted>
        <source src="https://github.com/ElwinRoy/ModelViewer/raw/main/nike.mp4" type="video/mp4">
      </video>
      <button class="visualize-button" id="visualizeBtn">View Models</button>
    </div>
  </div>

  <div id="modelsScreen">
    <div class="models-header">
      <h2>Choose Your Sneaker</h2>
      <p>Select a model to view in AR</p>
    </div>
    <div class="shoes-grid" id="shoesGrid"></div>
  </div>

  <div id="arDetailView">
    <model-viewer id="ar3DModel"
      ar 
      ar-modes="webxr scene-viewer quick-look"
      camera-controls
      touch-action="pan-y"
      shadow-intensity="1"
      exposure="1.0"
      interaction-prompt="none"
      environment-image="neutral">
      <button slot="ar-button" style="display:none;"></button>
    </model-viewer>

    <div class="color-indicator" id="colorIndicator">
      <div class="color-dot" id="colorDot" style="background: #888;"></div>
      <span id="colorName">Original</span>
    </div>

    <div class="size-info">
      <strong>AR MODE</strong>
      <div id="modelName">Sneaker</div>
    </div>

    <div class="scale-controls">
      <button class="scale-btn" id="zoomIn">+</button>
      <button class="scale-btn" id="zoomOut">‚àí</button>
      <div class="scale-label">ZOOM</div>
    </div>

    <div class="ar-controls">
      <button class="ar-control-btn" id="colorToggle">üé® Colors</button>
      <button class="ar-control-btn" id="rotateBtn">üîÑ Spin</button>
      <button class="ar-control-btn" id="resetBtn">‚Ü∫ Reset</button>
    </div>

    <div class="color-panel" id="colorPanel">
      <div class="color-label">Select Color</div>
      <div class="color-options">
        <button class="color-btn selected" data-color="original">
          <div class="color-preview" style="background: #888;"></div>
          Original
        </button>
        <button class="color-btn" data-color="midnight">
          <div class="color-preview" style="background: #1e1e23;"></div>
          Midnight
        </button>
        <button class="color-btn" data-color="snow">
          <div class="color-preview" style="background: #f5f5fa;"></div>
          Snow
        </button>
        <button class="color-btn" data-color="crimson">
          <div class="color-preview" style="background: #b42832;"></div>
          Crimson
        </button>
        <button class="color-btn" data-color="ocean">
          <div class="color-preview" style="background: #1e5aa0;"></div>
          Ocean
        </button>
        <button class="color-btn" data-color="forest">
          <div class="color-preview" style="background: #287850;"></div>
          Forest
        </button>
      </div>
    </div>

    <button id="closeARDetail">‚Üê Back to Models</button>
  </div>

  <script>
    const shoes = [
      { name: "New Balance 997", price: "‚Çπ14,999", model: "https://cdn.jsdelivr.net/gh/ElwinRoy/test@main/Shoe%2001%20(1).glb" },
      { name: "Formal Edge", price: "‚Çπ12,999", model: "https://cdn.jsdelivr.net/gh/ElwinRoy/test@main/Shoe%2002%20(1).glb" },
      { name: "ND Runner", price: "‚Çπ16,999", model: "https://cdn.jsdelivr.net/gh/ElwinRoy/test@main/Shoe%2003%20(1).glb" }
    ];

    const colorMap = {
      original: { r: 0.53, g: 0.53, b: 0.53, hex: '#888888', name: 'Original' },
      midnight: { r: 0.12, g: 0.12, b: 0.14, hex: '#1e1e23', name: 'Midnight' },
      snow: { r: 0.96, g: 0.96, b: 0.98, hex: '#f5f5fa', name: 'Snow' },
      crimson: { r: 0.71, g: 0.16, b: 0.2, hex: '#b42832', name: 'Crimson' },
      ocean: { r: 0.12, g: 0.35, b: 0.63, hex: '#1e5aa0', name: 'Ocean' },
      forest: { r: 0.16, g: 0.47, b: 0.31, hex: '#287850', name: 'Forest' }
    };

    const cameraBackground = document.getElementById("cameraBackground");
    const introScreen = document.getElementById("introScreen");
    const videoScreen = document.getElementById("videoScreen");
    const modelsScreen = document.getElementById("modelsScreen");
    const arDetailView = document.getElementById("arDetailView");
    const ar3DModel = document.getElementById("ar3DModel");
    const startBtn = document.getElementById("startBtn");
    const visualizeBtn = document.getElementById("visualizeBtn");
    const videoPlayer = document.getElementById("videoPlayer");
    const closeARDetail = document.getElementById("closeARDetail");
    const shoesGrid = document.getElementById("shoesGrid");
    const colorPanel = document.getElementById("colorPanel");
    const colorToggle = document.getElementById("colorToggle");
    const rotateBtn = document.getElementById("rotateBtn");
    const resetBtn = document.getElementById("resetBtn");
    const modelName = document.getElementById("modelName");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const colorDot = document.getElementById("colorDot");
    const colorNameEl = document.getElementById("colorName");
    const zoomIn = document.getElementById("zoomIn");
    const zoomOut = document.getElementById("zoomOut");

    let cameraStream = null;
    let autoRotate = false;
    let currentShoe = null;
    let originalMaterialColors = new Map();
    let hapticInterval = null;

    // ============ SMOOTH HAPTIC FUNCTIONS ============
    
    function haptic(duration = 30) {
      if (navigator.vibrate) {
        navigator.vibrate(duration);
      }
    }

    function stopHaptic() {
      if (navigator.vibrate) {
        navigator.vibrate(0);
      }
      if (hapticInterval) {
        clearInterval(hapticInterval);
        hapticInterval = null;
      }
    }

    // GENTLE startup haptic - soft pulses for ~5 seconds
    // Pattern: short gentle vibrations with pauses (like a heartbeat)
    function hapticStartupGentle() {
      if (navigator.vibrate) {
        // Gentle pattern: 30ms vibrate, 200ms pause, 30ms vibrate, 400ms pause... repeating
        // Total ~5 seconds of gentle pulsing
        const gentlePattern = [
          30, 200, 30, 400,  // pulse pulse ... pause
          30, 200, 30, 400,
          30, 200, 30, 400,
          30, 200, 30, 400,
          30, 200, 30, 400,
          30, 200, 30, 400,
          30, 200, 30, 400,
          30, 200, 30
        ];
        navigator.vibrate(gentlePattern);
      }
    }

    // SMOOTH video haptic - very subtle rhythmic pulses
    function startSmoothVideoHaptic() {
      stopHaptic();
      
      if (navigator.vibrate) {
        // Subtle pulse every 800ms - very gentle
        const smoothPulse = () => {
          navigator.vibrate(15); // Very short, gentle pulse
        };
        
        smoothPulse();
        hapticInterval = setInterval(smoothPulse, 800);
      }
    }

    // ============ CAMERA INIT ============

    async function initCamera() {
      const constraints = [
        { video: { facingMode: { exact: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } } },
        { video: { facingMode: "environment" } },
        { video: true }
      ];

      for (const constraint of constraints) {
        try {
          cameraStream = await navigator.mediaDevices.getUserMedia(constraint);
          cameraBackground.srcObject = cameraStream;
          await cameraBackground.play();
          return;
        } catch (err) { continue; }
      }
      document.body.style.background = "#1a1a2e";
    }

    initCamera();

    // Gentle startup haptic
    let startupDone = false;
    function triggerStartupHaptic() {
      if (!startupDone) {
        startupDone = true;
        hapticStartupGentle();
      }
    }

    setTimeout(triggerStartupHaptic, 500);
    document.addEventListener('touchstart', triggerStartupHaptic, { once: true });
    document.addEventListener('click', triggerStartupHaptic, { once: true });

    // ============ START BUTTON ============

    startBtn.onclick = async () => {
      stopHaptic();
      haptic(50); // Single tap feedback
      
      introScreen.style.display = "none";
      videoScreen.style.display = "flex";
      
      try {
        await videoPlayer.play();
        startSmoothVideoHaptic();
      } catch (e) {
        stopHaptic();
        videoScreen.style.display = "none";
        modelsScreen.style.display = "block";
      }
    };

    // ============ VIDEO EVENTS ============

    videoPlayer.addEventListener('error', () => {
      stopHaptic();
      videoScreen.style.display = "none";
      modelsScreen.style.display = "block";
    });

    videoPlayer.addEventListener('pause', () => {
      stopHaptic();
    });

    videoPlayer.addEventListener('play', () => {
      startSmoothVideoHaptic();
    });

    // ============ VISUALIZE BUTTON ============

    visualizeBtn.onclick = () => {
      stopHaptic();
      haptic(40);
      videoPlayer.pause();
      videoScreen.style.display = "none";
      modelsScreen.style.display = "block";
    };

    // ============ SHOE CARDS ============

    shoes.forEach((shoe, index) => {
      const card = document.createElement("div");
      card.className = "shoe-card";
      card.innerHTML = `
        <div class="model-wrap">
          <model-viewer 
            src="${shoe.model}" 
            auto-rotate
            rotation-per-second="25deg"
            camera-controls 
            shadow-intensity="0.5" 
            exposure="1.0"
            camera-orbit="0deg 75deg auto"
            field-of-view="auto"
            interaction-prompt="none"
            loading="eager">
          </model-viewer>
        </div>
        <div class="info">
          <h3>${shoe.name}</h3>
          <div class="price">${shoe.price}</div>
          <button class="btn-3d-home" data-index="${index}">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9H15V22H13V16H11V22H9V9H3V7H21V9Z"/>
            </svg>
            View in AR
          </button>
        </div>
      `;
      shoesGrid.appendChild(card);
    });

    // ============ VIEW IN AR ============

    document.querySelectorAll('.btn-3d-home').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        haptic(40);
        
        const index = parseInt(btn.getAttribute('data-index'));
        currentShoe = shoes[index];
        modelName.textContent = currentShoe.name;
        
        loadingOverlay.classList.add('active');
        modelsScreen.style.display = "none";
        arDetailView.style.display = "block";
        
        autoRotate = false;
        rotateBtn.classList.remove('active');
        
        ar3DModel.setAttribute('camera-orbit', '0deg 75deg auto');
        ar3DModel.setAttribute('field-of-view', 'auto');
        ar3DModel.src = currentShoe.model;
        
        ar3DModel.addEventListener('load', () => {
          storeOriginalColors();
          resetToOriginalColor();
          haptic(30);
          setTimeout(() => { loadingOverlay.classList.remove('active'); }, 400);
        }, { once: true });
        
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
        document.querySelector('.color-btn[data-color="original"]').classList.add('selected');
        updateColorIndicator('original');
      });
    });

    // ============ COLOR FUNCTIONS ============

    function storeOriginalColors() {
      originalMaterialColors.clear();
      const model = ar3DModel.model;
      if (model) {
        for (const material of model.materials) {
          const pbr = material.pbrMetallicRoughness;
          if (pbr && pbr.baseColorFactor) {
            originalMaterialColors.set(material.name, [...pbr.baseColorFactor]);
          }
        }
      }
    }

    function resetToOriginalColor() {
      const model = ar3DModel.model;
      if (model && originalMaterialColors.size > 0) {
        for (const material of model.materials) {
          const original = originalMaterialColors.get(material.name);
          if (original) material.pbrMetallicRoughness.setBaseColorFactor(original);
        }
      }
    }

    function applyColorToModel(colorKey) {
      const model = ar3DModel.model;
      if (!model) return;
      if (colorKey === 'original') { resetToOriginalColor(); return; }
      const color = colorMap[colorKey];
      if (!color) return;
      for (const material of model.materials) {
        const pbr = material.pbrMetallicRoughness;
        if (pbr) {
          const alpha = pbr.baseColorFactor ? pbr.baseColorFactor[3] : 1;
          pbr.setBaseColorFactor([color.r, color.g, color.b, alpha]);
        }
      }
    }

    function updateColorIndicator(colorKey) {
      const color = colorMap[colorKey];
      if (color) {
        colorDot.style.background = color.hex;
        colorNameEl.textContent = color.name;
      }
    }

    // ============ AR CONTROLS ============

    colorToggle.onclick = () => {
      haptic(20);
      colorPanel.classList.toggle('active');
      colorToggle.classList.toggle('active');
    };

    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        haptic(25);
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        const colorKey = btn.getAttribute('data-color');
        applyColorToModel(colorKey);
        updateColorIndicator(colorKey);
      });
    });

    let currentFOV = 45;
    
    zoomIn.onclick = () => {
      haptic(15);
      currentFOV = Math.max(15, currentFOV - 5);
      ar3DModel.setAttribute('field-of-view', currentFOV + 'deg');
    };

    zoomOut.onclick = () => {
      haptic(15);
      currentFOV = Math.min(80, currentFOV + 5);
      ar3DModel.setAttribute('field-of-view', currentFOV + 'deg');
    };

    rotateBtn.onclick = () => {
      haptic(25);
      autoRotate = !autoRotate;
      ar3DModel.autoRotate = autoRotate;
      if (autoRotate) ar3DModel.setAttribute('rotation-per-second', '25deg');
      rotateBtn.classList.toggle('active');
    };

    resetBtn.onclick = () => {
      haptic(40);
      ar3DModel.setAttribute('camera-orbit', '0deg 75deg auto');
      ar3DModel.setAttribute('field-of-view', 'auto');
      currentFOV = 45;
      ar3DModel.resetTurntableRotation();
      resetToOriginalColor();
      document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('.color-btn[data-color="original"]').classList.add('selected');
      updateColorIndicator('original');
    };

    closeARDetail.onclick = () => {
      haptic(30);
      arDetailView.style.display = "none";
      modelsScreen.style.display = "block";
      colorPanel.classList.remove('active');
      colorToggle.classList.remove('active');
      autoRotate = false;
      ar3DModel.autoRotate = false;
      rotateBtn.classList.remove('active');
    };

    arDetailView.addEventListener('click', (e) => {
      if (!colorPanel.contains(e.target) && e.target !== colorToggle && !colorToggle.contains(e.target)) {
        colorPanel.classList.remove('active');
        colorToggle.classList.remove('active');
      }
    });

    ar3DModel.addEventListener('error', () => { loadingOverlay.classList.remove('active'); });

    // ============ CLEANUP ============

    window.addEventListener('beforeunload', () => {
      stopHaptic();
      if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
    });

    document.addEventListener('visibilitychange', async () => {
      if (document.hidden) {
        stopHaptic();
        if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
      } else {
        await initCamera();
      }
    });
  </script>
</body>
</html>
